# PCIe

PCIe，全称为Peripheral Component Interconnect Express，是一种高速串行计算机扩展总线标准，被广泛用作主板上的扩展卡接口。它是PCI总线的继任者，旨在替代旧的PCI、PCI-X和AGP总线标准。由于其更高的传输速率和改进的协议效率，PCIe大幅提升了数据传输速度，并且已经成为现代计算机系统中最普遍的内部数据交换接口之一。

## 相关知识

* 全双工点到点串行连接

  独立的发射和接收侧

* 可缩放链路宽度
  x1，x2，x4，x8，x16，

* 可扩展链路速度
  2.5、5.0、8.0、16.0、32.0和64.0GT/s 

## PCIe链路

PCIe Link表示两个组件之间的全双工通信信道，是PCIe总线中两个设备之间的通信连接，采用点对点的通信架构，一条链路可以包含多个通道(lane)，可增加通道个数来满足更高的带宽要求。

![image-20231226120533938](https://github.com/apengaaa/usb-doc/blob/master/src/assert/1.21-1.png)



Lane，是指一组差分信号的组合，包括发送和接收。一个发送方向的差分信号包括TX+和TX-两条线，接收亦然。所以一条lane有四条物理连线。

![image-20231226143119817](https://github.com/apengaaa/usb-doc/blob/master/src/assert/1.21-2.png)



## PCIe拓扑结构

![image-20231226120936484](https://github.com/apengaaa/usb-doc/blob/master/src/assert/1.21-3.png)

1. **点对点连接：** PCIe总线采用点对点的通信方式，每个设备都直接连接到根复杂器（Root Complex）或其他中继设备。这种结构消除了共享总线的瓶颈，提供了更高的性能。
2. **树状结构：** PCIe的拓扑结构通常呈现为树状结构。根复杂器是总线的起点，连接到根复杂器的设备称为端点（Endpoint）。可以通过 Switch 进一步连接到其他设备，形成一个树状的拓扑结构。
3. **根复杂器 Root Complex（RC）：** RC是PCIe总线的起点，负责初始化和管理总线。RC可以连接到CPU、北桥芯片组或其他I/O控制器。
4. **PCIe Bridge To PCI/PCI-X**： 桥接设备，可以连接不同的PCIe域，例如连接其他的PCI总线、PCI-X、PCIe总线。
5. **Switch**： PCIe的转接器设备（PCIe扩展端口），为挂载设备提供路由以及转发服务；Switch的内部结构可以看作由PCI桥组成，在Switch中，每个端口对应的PCIe设备号是确定的，Switch设备会记录下游PCIe端口连接设备分配到的PCIe地址，在接收到TLP包时，通过比较目的地址和下游设备的地址，来判断是否转发以及转发到哪个PCIe端口。
6. **端点设备 PCIe Endponit（EP）：** 端点是直接连接到PCIe总线的终端设备，如显卡、网卡等。每个设备都有自己的设备标识和唯一的设备ID。
7. **链路：** 链路是连接PCIe设备的通信通道，可以根据需要进行配置。链路的宽度（Link Width）和速度（Link Speed）是PCIe连接的关键参数，决定了数据传输的带宽和速率。
8. **多域拓扑：** PCIe支持多域拓扑，允许将PCIe总线划分为不同的域，每个域内有独立的根复杂器和设备。

## PCIe架构

PCIe架构包括四个主要层次：物理层（Physical Layer）、数据链路层（Data Link Layer）、传输层（Transaction Layer）、应用层（Application Layer）。

### 1. 物理层（Physical Layer）：

- **电气特性：** 定义了PCIe信号的电气特性，包括电压水平、时钟频率等。PCIe使用差分信号传输，以提高抗干扰性和传输速率。
- **连接器和插槽：** 规定了物理连接的标准，包括插槽的形状和尺寸，以及连接器的设计。常见的物理连接形式包括x1、x4、x8、x16等。
- **数据传输：** 负责将数据以数据包的形式传输到数据链路层。物理层还管理时序、流控和数据逐字节的传输。

### 2. 数据链路层（Data Link Layer）：

- **数据包组装：** 将数据划分为适当大小的数据包，并在每个数据包上添加控制信息，包括起始和终止标志、错误检测和纠错码等。
- **流量控制：** 确保数据在物理层上的稳定传输，避免因接收方处理能力不足而导致数据丢失。
- **错误检测和纠错：** 负责检测并在可能的情况下纠正传输中的错误，以确保数据的可靠性。

### 3. 传输层（Transaction Layer）：

- **传输事务：** 负责将数据包分解为传输层事务，并在设备之间传递这些事务。每个事务包含有关数据的信息、目标设备的地址等。
- **路由：** 确定数据包的路径，使其能够正确地传递到目标设备。传输层支持多通道和多队列，以提高并行性和性能。
- **可靠性：** 确保数据传输的可靠性，包括重传机制、流控等。

### 4. 应用层（Application Layer）：

- **与操作系统和应用程序的接口：** 提供PCIe设备与主机系统之间的通信接口。在这一层，操作系统通过相应的驱动程序与PCIe设备进行交互。
- **配置和管理：** 应用层处理PCIe设备的配置信息，包括设备ID、中断分配等。此外，它还负责设备的启动和关闭。



